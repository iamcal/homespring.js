/* homespring.js 2021-05-07 */
"use strict";!function(){var t,a={const:{YOUNG:1,MATURE:2,UPSTREAM:3,DOWNSTREAM:4,TOKENIZE_RX:5,TOKENIZE_STR:6},Exception:function(t){this.message=t,this.name="HS.Exception"},Program:function(t,n){var e=this;return e.options={strictMode:!!(n=n||{}).strictMode,traceTicks:!!n.traceTicks,tokenizer:a.const.TOKENIZE_STR},n.tokenizer==a.const.TOKENIZE_RX&&(e.options.tokenizer=n.tokenizer),e.nodesUsed={},e.tokens=e.tokenize(t),e.nodes=e.build_tree(e.tokens),e.root=e.nodes.length?e.nodes[0]:null,e.preOrderList=[],e.root&&e.preOrderPopulate(e.root),e.postOrderList=[],e.root&&e.postOrderPopulate(e.root),e.endThisTick=!1,e.salmon_uid=1,e.tickNum=0,e.terminated=!1,e.input=null,e}};for(t in a.Program.prototype.build_tree=function(t){var n=this;if(!t.length)return[];for(var e=1,o=n.create_node(e++,t[0]),r=o,i=[o],s=1;s<t.length;s++)if(""==t[s])if(r.parent)r=r.parent;else{if(n.options.strictMode)throw new a.Exception("Illegal program - traversed beyond root");var c=n.create_node(e++,"",r);i.push(c),r=c}else{c=n.create_node(e++,t[s],r);i.push(c),r=c}return i},a.Program.prototype.create_node=function(t,n,e){var o=n.toLowerCase().replace(/ /g,"_");return a.NodeDefs[o]?(this.nodesUsed[o]=1,new a.NodeDefs[o](this,t,n,e)):new a.SpringNode(this,t,n,e)},a.Program.prototype.preOrderPopulate=function(t){this.preOrderList.push(t);for(var n=0;n<t.kids.length;n++)this.preOrderPopulate(t.kids[n])},a.Program.prototype.postOrderPopulate=function(t){for(var n=0;n<t.kids.length;n++)this.postOrderPopulate(t.kids[n]);this.postOrderList.push(t)},a.Program.prototype.onOutput=function(t){},a.Program.prototype.onTerminate=function(){},a.Node=function(t,n,e,o){var r=this;return r.program=t,r.uid=n,r.name=e,r.lname=e.toLowerCase(),r.parent=o,r.kids=[],r.salmon=[],r.born=[],o&&(o.kids.push(r),r.childIndex=o.kids.length),r.is_snowy=null,r.is_watered=null,r.generates_power=null,r.is_destroyed=!1,r.prev_snow=!1,r},a.Node.prototype.toString=function(){var t="";return this.is_destroyed&&(t+=":destroyed"),this.generates_power&&(t+=":P"),this.isPowered()&&(t+=":p"),this.is_snowy&&(t+=":s"),this.is_watered&&(t+=":w"),this.blocksPower()&&(t+=":BP"),this.blocksWater()&&(t+=":BW"),this.blocksSnowmelt()&&(t+=":BS"),this.safeName()+t},a.Node.prototype.safeName=function(){return this.name.replace(/\n/g,"\\n")},a.Node.prototype.generatesPower=function(){return!1},a.Node.prototype.blocksPower=function(){return!1},a.Node.prototype.blocksWater=function(){return!1},a.Node.prototype.blocksSnowmelt=function(){return!1},a.Node.prototype.canFishLeave=function(t){return!0},a.Node.prototype.canFishLeaveFor=function(t,n){return!0},a.Node.prototype.canFishEnter=function(t){return!0},a.Node.prototype.canBeDestroyed=function(){return!1},a.Node.prototype.onFishEnters=function(t){},a.Node.prototype.onMiscTick=function(){},a.Node.prototype.fishHatchTick=function(){},a.Node.prototype.isPowered=function(){var t=this;if(t.generates_power)return!0;if(t.blocksPower())return!1;for(var n=0;n<t.kids.length;n++)if(t.kids[n].isPowered())return!0;return!1},a.Node.prototype.waterTick=function(){var t=this;if(t.is_watered=!1,!t.blocksWater())for(var n=0;n<t.kids.length;n++)if(t.kids[n].is_watered)return void(t.is_watered=!0)},a.Node.prototype.snowTick=function(){var t=this;!t.hasSnowyChildren()||t.blocksSnowmelt()?t.is_snowy=!1:(t.is_snowy=!0,!t.is_destroyed&&t.canBeDestroyed()&&(t.program.debug("destroying node "+t),t.is_destroyed=!0))},a.Node.prototype.fishTickEnd=function(){var t=this;t.salmon=t.born.concat(t.salmon),t.born=[]},a.Node.prototype.hasSnowyChildren=function(){for(var t=0;t<this.kids.length;t++)if(this.kids[t].is_snowy)return!0;return!1},a.Node.prototype.fishEnters=function(t){this.onFishEnters(t),this.salmon.unshift(t)},a.Node.prototype.canFindNamedNode=function(t){var n=this;if(n.name==t)return!0;for(var e=0;e<n.kids.length;e++)if(n.kids[e].canFindNamedNode(t))return!0;return!1},a.Node.prototype.filterSalmon=function(t){for(var n=[],e=0;e<this.salmon.length;e++)t(this.salmon[e],n);this.salmon=n},a.Node.prototype.matchSalmon=function(t){for(var n=0;n<this.salmon.length;n++)if(t(this.salmon[n]))return!0;return!1},a.Node.prototype.matchSalmonUpstream=function(t){for(var n=0;n<this.salmon.length;n++)if(t(this.salmon[n]))return!0;for(n=0;n<this.kids.length;n++)if(this.kids[n].matchSalmonUpstream(t))return!0;return!1},a.Node.prototype.spawnAllUpstream=function(){var e=this;e.filterSalmon(function(t,n){t.spawn(e),n.push(t)});for(var t=0;t<e.kids.length;t++)e.kids[t].spawnAllUpstream();e.fishTickEnd()},a.SpringNode=function(){a.Node.apply(this,arguments)},a.SpringNode.prototype=Object.create(a.Node.prototype),a.SpringNode.prototype.waterTick=function(){this.is_watered=!0},a.Salmon=function(t,n,e,o,r){var i=this;return i.program=t,i.uid=t.salmon_uid++,i.name=n,i.age=e,i.direction=o,i.childFrom=r,i.justSpawned=!1,i.spawnChild=null,i.ready=!0,i.dead=!1,i},a.Salmon.prototype.safeName=function(){return this.name.replace(/\n/g,"\\n")},a.Salmon.prototype.toString=function(){var t="";this.direction==a.const.DOWNSTREAM&&(t=":down"),this.direction==a.const.UPSTREAM&&(t=":up");var n="";return this.age==a.const.YOUNG&&(n=":young"),this.age==a.const.MATURE&&(n=":mature"),this.safeName()+n+t},a.Salmon.prototype.spawn=function(t){var n=this,e=new a.Salmon(n.program,t.name,a.const.YOUNG,a.const.DOWNSTREAM,1);return t.born.unshift(e),n.age=a.const.MATURE,n.direction=a.const.DOWNSTREAM,n.justSpawned=!0,n.spawnChild=e},a.Program.prototype.debug=function(t){this.options.traceTicks&&console.log(t)},a.Program.prototype.tokenize=function(t){if(0<=t.indexOf("\t"))throw new a.Exception("Illegal program - contains tabs");if(0<=t.indexOf(" . "))throw new a.Exception("Illegal program - contains space-dot-space");if(0<=t.indexOf(". ."))throw new a.Exception("Illegal program - contains dot-space-dot");return this.options.tokenizer==a.const.TOKENIZE_STR?this.tokenize_str(t):this.tokenize_rx(t)},a.Program.prototype.tokenize_rx=function(t){for(var n=/^(\. | \.|[^ \n\.])*\.?[ \n]/,e=/^.*\.\n/,o=[],r=t+" ";r.length;)var i=n.exec(r),r=null!=i?(null!=e.exec(i[0])?o.push(this.cleanToken(i[0])):o.push(this.cleanToken(i[0].substr(0,i[0].length-1))),r.substr(i[0].length)):(o.push(""),r.substr(1));return""==o[o.length-1]&&o.pop(),o},a.Program.prototype.cleanToken=function(t){return t.replace(/([^ ]|^)\.($|[^ ])/g,"$1$2").replace(/\. /g," ").replace(/ \./g,".")},a.Program.prototype.tokenize_str=function(t){for(var n=[],e=t.split(""),o="",r=e.length,i=0;i<r;i++)if(" "==e[i])"."==e[i+1]&&""!=o?(o+=".",i++):(n.push(o),o="");else if("\n"==e[i])n.push(o),o="";else if("."==e[i])if(" "==e[i+1])o+=" ",i++;else if("\n"==e[i+1])n.push(o+="\n"),o="",i++;else if("."==e[i+1]){for(var s=o.length+2;0<s;s--)n.push("");o="",i++}else{for(s=o.length+1;0<s;s--)n.push("");o=""}else o+=e[i];return o.length&&n.push(o),n},a.Program.prototype.run=function(t){this.maxTicks=t,this.intervalId=setInterval(this.tick.bind(this),0)},a.Program.prototype.runSync=function(t){var n=this;n.maxTicks=t;var e=n.onOutput,o="";for(n.onOutput=function(t){o+=t,e(t)};!n.terminated;)n.tick();return n.onOutput=e,o},a.Program.prototype.tick=function(){var t=this;if(!t.terminated)return t.root?null!=t.maxTicks&&t.tickNum>=t.maxTicks?(t.debug("stopped run after maxTicks ("+t.maxTicks+") ticks"),void t.terminate()):(t.tickNum++,t.onTickStart&&t.onTickStart(),t.startTick(),t.snowTick(),t.waterTick(),t.powerTick(),t.fishTick(),t.miscTick(),t.endThisTick||t.inputTick(),t.onTickEnd&&t.onTickEnd(),void(t.endThisTick&&t.terminate())):(t.onOutput("In Homespring, the null program is not a quine.\n"),void t.terminate())},a.Program.prototype.terminate=function(){this.terminated=!0,null!=this.intervalId&&(clearInterval(this.intervalId),this.intervalId=void 0),this.onTerminate()},a.Program.prototype.snowTick=function(){this.debug("starting snow tick #"+this.tickNum),this.preOrder(function(t){t.snowTick()})},a.Program.prototype.waterTick=function(){this.debug("starting water tick #"+this.tickNum),this.preOrder(function(t){t.waterTick()})},a.Program.prototype.powerTick=function(){this.debug("starting power tick #"+this.tickNum),this.preOrder(function(t){t.generates_power=t.generatesPower()})},a.Program.prototype.fishTick=function(){var t=this;t.debug("starting fish tick #"+t.tickNum),t.fishTickDown(),t.fishTickUp(),t.fishTickHatch(),t.fishTickEnd()},a.Program.prototype.fishTickDown=function(){var o=this;o.debug("starting fish tick down #"+o.tickNum),o.preOrder(function(e){e.filterSalmon(function(t,n){return t.direction==a.const.DOWNSTREAM?t.ready?e.canFishLeave(t)?e.parent?void(e.parent.canFishEnter(t)?(t.childFrom=e.childIndex,e.parent.fishEnters(t)):n.push(t)):(o.onOutput(t.name,t),void(t.dead=!0)):void n.push(t):(n.push(t),void(t.ready=!0)):void n.push(t)})})},a.Program.prototype.fishTickUp=function(){this.debug("starting fish tick up #"+this.tickNum),this.postOrder(function(o){o.filterSalmon(function(t,n){if(t.direction==a.const.UPSTREAM){if(!t.ready)return n.push(t),void(t.ready=!0);if(o.name==t.name)return t.spawn(o),void n.push(t);if(!o.canFishLeave(t))return t.spawn(o),void n.push(t);for(var e=0;e<o.kids.length;e++)if(o.kids[e].canFindNamedNode(t.name)&&o.kids[e].canFishEnter(t)&&o.canFishLeaveFor(t,o.kids[e]))return void o.kids[e].fishEnters(t);for(e=0;e<o.kids.length;e++)if(o.kids[e].canFishEnter(t)&&o.canFishLeaveFor(t,o.kids[e]))return t.childFrom=0,void o.kids[e].fishEnters(t);t.spawn(o),n.push(t)}else n.push(t)})})},a.Program.prototype.fishTickHatch=function(){this.debug("starting fish tick hatch #"+this.tickNum),this.preOrder(function(t){t.fishHatchTick()})},a.Program.prototype.fishTickEnd=function(){this.preOrder(function(t){t.fishTickEnd()})},a.Program.prototype.preOrder=function(t){for(var n=0;n<this.preOrderList.length;n++)t(this.preOrderList[n])},a.Program.prototype.postOrder=function(t){for(var n=0;n<this.postOrderList.length;n++)t(this.postOrderList[n])},a.Program.prototype.preOrderSalmon=function(e){this.preOrder(function(t){for(var n=0;n<t.salmon.length;n++)e(t,t.salmon[n])})},a.Program.prototype.getSalmon=function(){var e=[];return this.preOrderSalmon(function(t,n){e.push([t,n])}),e},a.Program.prototype.miscTick=function(){this.debug("starting misc tick #"+this.tickNum),this.preOrder(function(t){t.onMiscTick()})},a.Program.prototype.startTick=function(){this.preOrderSalmon(function(t,n){n.justSpawned=!1})},a.Program.prototype.inputTick=function(){var t,n=this;n.debug("starting input tick #"+n.tickNum),null!=n.input&&null!=n.input&&(t=new a.Salmon(n,n.input,a.const.MATURE,a.const.UPSTREAM,1),n.root.fishEnters(t),n.input=null)},a.Program.prototype.dumpState=function(){console.log(""),console.log("## World state after tick "+this.tickNum);for(var t=0;t<this.nodes.length;t++){for(var n=this.nodes[t],e=0,o=n;o.parent;)e++,o=o.parent;for(var r=[],i=0;i<n.salmon.length;i++)r.push(n.salmon[i].toString());var r="["+r.join(",")+"]",s=new Array(e+1).join("  ");console.log(s+this.nodes[t].toString()+r)}},a.Nodes={},a.Nodes.append_down={onMiscTick:function(){for(var t=this,n=[],e="",o=0;o<t.salmon.length;o++)t.salmon[o].direction==a.const.DOWNSTREAM&&1!=t.salmon[o].childFrom?(e+=t.salmon[o].name,t.salmon[o].dead=!0):n.push(t.salmon[o]);for(o=0;o<n.length;o++)n[o].direction==a.const.DOWNSTREAM&&(n[o].name+=e);t.salmon=n}},a.Nodes.append_up={onMiscTick:function(){var o=this;o.filterSalmon(function(t,n){if(t.direction==a.const.DOWNSTREAM&&1!=t.childFrom){t.dead=!0;for(var e=0;e<o.salmon.length;e++)o.salmon[e].direction==a.const.UPSTREAM&&(o.salmon[e].name+=t.name)}else n.push(t)})}},a.Nodes.bear={onMiscTick:function(){this.filterSalmon(function(t,n){t.age==a.const.MATURE?t.dead=!0:n.push(t)})}},a.Nodes.bird={onMiscTick:function(){this.filterSalmon(function(t,n){t.age==a.const.YOUNG?t.dead=!0:n.push(t)})}},a.Nodes.bridge={blocksWater:function(){return this.is_destroyed},blocksSnowmelt:function(){return this.is_destroyed},canFishEnter:function(t){return!this.is_destroyed},canBeDestroyed:function(){return!0}},a.Nodes.clone={onMiscTick:function(){for(var t=this.salmon.length,n=0;n<t;n++)this.salmon.push(new a.Salmon(this.program,this.salmon[n].name,a.const.YOUNG,a.const.DOWNSTREAM,1))}},a.Nodes.current={canFishEnter:function(t){return t.age!=a.const.YOUNG}},a.Nodes.downstream_sense={blocksPower:function(){return this.matchSalmon(function(t){return t.age==a.const.MATURE&&t.direction==a.const.DOWNSTREAM})}},a.Nodes.evaporates={blocksWater:function(){return this.isPowered()},blocksSnowmelt:function(){return this.isPowered()}},a.Nodes.fear={canFishEnter:function(){return!this.isPowered()}},a.Nodes.force_down={canFishLeaveFor:function(t,n){return n.childIndex!=this.kids.length}},a.Nodes.force_field={blocksWater:function(){return this.isPowered()},blocksSnowmelt:function(){return this.isPowered()},canFishLeave:function(){return!this.isPowered()}},a.Nodes.force_up={canFishLeaveFor:function(t,n){return 1!=n.childIndex}},a.Nodes.hatchery={canBeDestroyed:function(){return!0},fishHatchTick:function(){var t;this.isPowered()&&!this.is_destroyed&&(t=new a.Salmon(this.program,"homeless",a.const.YOUNG,a.const.UPSTREAM,1),this.born.unshift(t))}},a.Nodes.hydro_power={generatesPower:function(){return this.is_watered&&!this.is_destroyed},canBeDestroyed:function(){return!0}},a.Nodes.insulated={blocksPower:function(){return!0}},a.Nodes.inverse_lock={blocksSnowmelt:function(){return!this.isPowered()},canFishEnter:function(t){return this.isPowered()||t.direction!=a.const.DOWNSTREAM}},a.Nodes.lock={blocksSnowmelt:function(){return this.isPowered()},canFishEnter:function(t){return!(this.isPowered()&&t.direction==a.const.DOWNSTREAM)}},a.Nodes.marshy={snowTick:function(){this.is_snowy=this.prev_snow,this.prev_snow=this.hasSnowyChildren()}},a.Nodes.narrows={canFishEnter:function(t){return 0==this.salmon.length}},a.Nodes.net={canFishEnter:function(t){return t.age!=a.const.MATURE}},a.Nodes.oblivion={canBeDestroyed:function(){return!0},onMiscTick:function(){this.isPowered()&&!this.is_destroyed&&this.filterSalmon(function(t,n){t.name="",n.push(t)})}},a.Nodes.power_invert={canBeDestroyed:function(){return!0},isPowered:function(){if(this.is_destroyed)return a.Node.prototype.isPowered.apply(this);for(var t=0;t<this.kids.length;t++)if(this.kids[t].isPowered())return!1;return!0}},a.Nodes.powers={generatesPower:function(){return!0}},a.Nodes.pump={canFishEnter:function(t){return this.isPowered()}},a.Nodes.range_sense={blocksPower:function(){return this.matchSalmonUpstream(function(t){return t.age==a.const.MATURE})}},a.Nodes.range_switch={blocksPower:function(){return!this.matchSalmonUpstream(function(t){return t.age==a.const.MATURE})}},a.Nodes.rapids={onFishEnters:function(t){t.age==a.const.YOUNG&&(t.ready=!1)}},a.Nodes.reverse_down={onMiscTick:function(){var e=this;e.kids.length<2||e.filterSalmon(function(t,n){t.direction==a.const.DOWNSTREAM&&1==t.childFrom?(t.direction=a.const.UPSTREAM,e.kids[1].canFishEnter(t)?e.kids[1].fishEnters(t):(t.direction=a.const.DOWNSTREAM,n.push(t))):n.push(t)})}},a.Nodes.reverse_up={onMiscTick:function(){var e=this;e.kids.length<2||this.filterSalmon(function(t,n){t.direction==a.const.DOWNSTREAM&&2==t.childFrom?(t.direction=a.const.UPSTREAM,e.kids[0].canFishEnter(t)?e.kids[0].fishEnters(t):(t.direction=a.const.DOWNSTREAM,n.push(t))):n.push(t)})}},a.Nodes.sense={blocksPower:function(){return this.matchSalmon(function(t){return t.age==a.const.MATURE})}},a.Nodes.shallows={onFishEnters:function(t){t.age==a.const.MATURE&&(t.ready=!1)}},a.Nodes.snowmelt={snowTick:function(){this.is_snowy=!0}},a.Nodes.spawn={onMiscTick:function(){this.isPowered()&&this.spawnAllUpstream()}},a.Nodes.split={onMiscTick:function(){var r=this;this.filterSalmon(function(t,n){t.dead=!0;for(var e=t.name.split(""),o=0;o<e.length;o++)r.born.push(new a.Salmon(r.program,e[o],t.age,t.direction,t.childFrom))}),r.salmon=r.born,r.born=[]}},a.Nodes.switch={blocksPower:function(){return!this.matchSalmon(function(t){return t.age==a.const.MATURE})}},a.Nodes.time={onMiscTick:function(){this.filterSalmon(function(t,n){t.age=a.const.MATURE,n.push(t)})}},a.Nodes.universe={canBeDestroyed:function(){return!0},onMiscTick:function(){this.is_destroyed&&(this.program.endThisTick=!0,this.program.debug("universe has been destroyed - program exits!"))}},a.Nodes.upstream_killing_device={onMiscTick:function(){this.isPowered()&&1<this.kids.length&&this.kids[this.kids.length-1].filterSalmon(function(t,n){t.dead=!0})}},a.Nodes.upstream_sense={blocksPower:function(){return this.matchSalmon(function(t){return t.age==a.const.MATURE&&t.direction==a.const.UPSTREAM})}},a.Nodes.waterfall={canFishLeave:function(t){return t.direction!=a.const.UPSTREAM}},a.Nodes.young_bear={onMiscTick:function(){for(var t=this,n=[],e=[],o=!1,r=0;r<t.salmon.length;r++)t.salmon[r].age==a.const.MATURE?(o?t.salmon[r].dead=!0:e.push(t.salmon[r]),o=!o):n.push(t.salmon[r]);t.salmon=n.concat(e)}},a.Nodes.young_range_sense={blocksPower:function(){return this.matchSalmonUpstream(function(t){return t.age==a.const.YOUNG})}},a.Nodes.young_range_switch={blocksPower:function(){return!this.matchSalmonUpstream(function(t){return t.age==a.const.YOUNG})}},a.Nodes.young_sense={blocksPower:function(){return this.matchSalmon(function(t){return t.age==a.const.YOUNG})}},a.Nodes.young_switch={blocksPower:function(){return!this.matchSalmon(function(t){return t.age==a.const.YOUNG})}},a.Nodes.youth_fountain={onMiscTick:function(){this.filterSalmon(function(t,n){t.age=a.const.YOUNG,n.push(t)})}},a.Nodes.force_down.onMiscTick=a.Nodes.reverse_down.onMiscTick,a.Nodes.force_up.onMiscTick=a.Nodes.reverse_up.onMiscTick,a.NodeDefs={},a.Nodes)for(var n in a.NodeDefs[t]=function(){a.Node.apply(this,arguments)},a.NodeDefs[t].prototype=Object.create(a.Node.prototype),a.Nodes[t])a.NodeDefs[t].prototype[n]=a.Nodes[t][n];"undefined"!=typeof exports?(exports="undefined"!=typeof module&&module.exports?module.exports=a:exports).HS=a:"function"==typeof define&&define.amd?define(function(){return a}):this.HS=a}.call(function(){return this||("undefined"!=typeof window?window:global)}());
