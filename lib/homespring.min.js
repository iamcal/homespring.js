/*! homespring.js 2017-01-09 */
"use strict";(function(){var a=this,b={};b["const"]={YOUNG:1,MATURE:2,UPSTREAM:3,DOWNSTREAM:4},b.Exception=function(a){this.message=a,this.name="HS.Exception"},b.Program=function(a,b){var c=this;return c.debugMode=!!b,c.tokens=c.tokenize(a),c.nodes=c.build_tree(c.tokens),c.root=c.nodes.length?c.nodes[0]:null,c.tickNum=0,c.endThisTick=!1,c.salmon_uid=1,c},b.Program.prototype.build_tree=function(a){var c=this;if(!a.length)return[];for(var d=1,e=c.create_node(d++,a[0]),f=e,g=[e],h=1;h<a.length;h++)if(""==a[h]){if(f=f.parent,!f)throw new b.Exception("Illegal program - traversed beyond root")}else{var i=c.create_node(d++,a[h],f);g.push(i),f=i}return g},b.Program.prototype.create_node=function(a,c,d){var e=c.toLowerCase().replace(/ /g,"_");return b.NodeDefs[e]?new b.NodeDefs[e](this,a,c,d):new b.SpringNode(this,a,c,d)},b.Node=function(a,b,c,d){var e=this;return e.program=a,e.uid=b,e.name=c,e.lname=c.toLowerCase(),e.parent=d,e.kids=[],e.salmon=[],d&&d.kids.push(e),e.is_snowy=null,e.is_watered=null,e.generates_power=null,e.is_destroyed=!1,e.prev_snow=!1,e},b.Node.prototype.toString=function(){return this.uid+":"+this.name},b.Node.prototype.generatesPower=function(){return!1},b.Node.prototype.blocksPower=function(){return!1},b.Node.prototype.blocksWater=function(){return!1},b.Node.prototype.blocksSnowmelt=function(){return!1},b.Node.prototype.canFishLeave=function(a){return!0},b.Node.prototype.canFishEnter=function(a){return!0},b.Node.prototype.canBeDestroyed=function(){return!1},b.Node.prototype.isSpring=function(){return!1},b.Node.prototype.onFishEnters=function(a){},b.Node.prototype.onMiscTick=function(){},b.Node.prototype.isPowered=function(){var a=this;if(a.generates_power)return!0;if(a.blocksPower())return!1;if("power invert"==a.lname){for(var b=0;b<a.kids;b++)if(a.kids[b].isPowered())return!1;return!0}for(var b=0;b<a.kids.length;b++)if(a.kids[b].isPowered())return!0;return!1},b.Node.prototype.fishEnters=function(a){var b=this;b.onFishEnters(a),b.salmon.unshift(a)},b.Node.prototype.canFindNamedNode=function(a){var b=this;if(b.name==a)return!0;for(var c=0;c<b.kids.length;c++)if(b.kids[c].canFindNamedNode(a))return!0;return!1},b.Node.prototype.filterSalmon=function(a){for(var b=[],c=0;c<this.salmon.length;c++)a(this.salmon[c],b);this.salmon=b},b.Node.prototype.hasMatureSalmon=function(){for(var a=0;a<this.salmon.length;a++)if(this.salmon[a].age==b["const"].MATURE)return!0;return!1},b.SpringNode=function(){b.Node.apply(this,arguments)},b.SpringNode.prototype=Object.create(b.Node.prototype),b.SpringNode.prototype.isSpring=function(){return!0},b.Salmon=function(a,b,c,d){var e=this;return e.program=a,e.uid=a.salmon_uid++,e.name=b,e.age=c,e.direction=d,e.justSpawned=!1,e.spawnChild=null,e.ready=!0,e},b.Salmon.prototype.toString=function(){var a=this.direction==b["const"].DOWNSTREAM?"downstream":this.direction==b["const"].UPSTREAM?"upstream":"?",c=this.age==b["const"].YOUNG?"young":this.age==b["const"].MATURE?"mature":"?";return this.uid+":"+this.name+"("+a+"/"+c+")"},b.Salmon.prototype.spawn=function(a){var c=this;c.age=b["const"].MATURE,c.direction=b["const"].DOWNSTREAM;var d=new b.Salmon(c.program,a.name,b["const"].YOUNG,b["const"].DOWNSTREAM);return c.justSpawned=!0,c.spawnChild=d,d},b.Program.prototype.debug=function(a){var b=this;b.debugMode&&console.log(a)},b.Program.prototype.tokenize=function(a){var c=this;if(a.indexOf("\t")>=0)throw new b.Exception("Illegal program - contains tabs");if(a.indexOf(" . ")>=0)throw new b.Exception("Illegal program - contains space-dot-space");if(a.indexOf(". .")>=0)throw new b.Exception("Illegal program - contains dot-space-dot");for(var d=[],e=a.split(""),f="",g=e.length,h=0;h<g;h++)if(" "==e[h])"."==e[h+1]?(f+=".",h++):(d.push(f),f="");else if("\n"==e[h])d.push(f),f="";else if("."==e[h])if(" "==e[h+1])f+=" ",h++;else{if("\n"!=e[h+1])return c.debug("parser error - unexpected period followewd by "+e[h+1]),[];f+="\n",d.push(f),f="",h++}else f+=e[h];return f.length&&d.push(f),d},b.Program.prototype.run=function(a){for(var b=this,c=a||10,d=0;d<c&&!b.endThisTick;)b.tick(),d++;b.endThisTick?b.debug("program terminated"):b.debug("stopped run after "+d+" ticks")},b.Program.prototype.tick=function(){var a=this;a.tickNum++,a.startTick(),a.snowTick(),a.waterTick(),a.powerTick(),a.fishTick(),a.miscTick(),a.inputTick()},b.Program.prototype.snowTick=function(){var a=this;a.debug("starting snow tick #"+a.tickNum),a.preOrder(function(b){if("snowmelt"==b.lname)return void(b.is_snowy=!0);for(var c=!1,d=0;d<b.kids.length;d++)if(b.kids[d].is_snowy){c=!0;break}return"marshy"==b.lname?(b.is_snowy=b.prev_snow,void(b.prev_snow=c)):c?b.blocksSnowmelt()?void(b.is_snowy=!1):(b.is_snowy=!0,"universe"==b.lname&&(a.endThisTick=!0),void(b.canBeDestroyed()&&(b.old_name=b.name,b.old_lname=b.lname,b.name="",b.lname="",b.is_destroyed=!0))):void(b.is_snowy=!1)})},b.Program.prototype.waterTick=function(){var a=this;a.debug("starting water tick #"+a.tickNum),a.postOrder(function(a){if(a.blocksWater())return void(a.is_watered=!1);if(a.isSpring())return void(a.is_watered=!0);for(var b=0;b<a.kids.length;b++)if(a.kids[b].is_watered)return void(a.is_watered=!0);a.is_watered=!1})},b.Program.prototype.powerTick=function(){var a=this;a.debug("starting power tick #"+a.tickNum),a.preOrder(function(a){a.generates_power=a.generatesPower()})},b.Program.prototype.fishTick=function(){var a=this;a.debug("starting fish tick #"+a.tickNum),a.fishTickDown(),a.fishTickUp(),a.fishTickHatch()},b.Program.prototype.fishTickDown=function(){var a=this;a.debug("starting fish tick down #"+a.tickNum),a.preOrder(function(c){c.filterSalmon(function(d,e){return d.direction!=b["const"].DOWNSTREAM?void e.push(d):d.ready?c.canFishLeave(d)?c.parent?c.parent.canFishEnter(d)?void c.parent.fishEnters(d):void e.push(d):void a.debug("salmon made it out to world: "+d.name):void e.push(d):(e.push(d),void(d.ready=!0))})})},b.Program.prototype.fishTickUp=function(){var a=this;a.debug("starting fish tick up #"+a.tickNum),a.postOrder(function(a){a.filterSalmon(function(c,d){if(c.direction!=b["const"].UPSTREAM)return void d.push(c);if(!c.ready)return d.push(c),void(c.ready=!0);if(!a.canFishLeave(c))return d.push(c),void d.push(c.spawn(a));for(var e=0;e<a.kids.length;e++)if(a.kids[e].canFindNamedNode(c.name)&&a.kids[e].canFishEnter(c))return void a.kids[e].fishEnters(c);for(var e=0;e<a.kids.length;e++)if(a.kids[e].canFishEnter(c))return void a.kids[e].fishEnters(c);d.push(c),d.push(c.spawn(a))})})},b.Program.prototype.fishTickHatch=function(){var a=this;a.debug("starting fish tick hatch #"+a.tickNum),a.preOrder(function(c){if("hatchery"==c.lname&&c.isPowered()){var d=new b.Salmon(a,"homeless",b["const"].MATURE,b["const"].UPSTREAM);c.salmon.unshift(d)}})},b.Program.prototype.preOrder=function(a){for(var b=this,c=0;c<b.nodes.length;c++)a(b.nodes[c])},b.Program.prototype.postOrder=function(a){for(var b=this,c=b.nodes.length-1;c>=0;c--)a(b.nodes[c])},b.Program.prototype.preOrderSalmon=function(a){var b=this;b.preOrder(function(b){for(var c=0;c<b.salmon.length;c++)a(b,b.salmon[c])})},b.Program.prototype.dumpFish=function(){var a=this;a.preOrderSalmon(function(b,c){a.debug(b+" - "+c)})},b.Program.prototype.miscTick=function(){var a=this;a.debug("starting misc tick #"+a.tickNum),a.endThisTick&&a.debug("program exits!"),a.preOrder(function(a){a.onMiscTick()})},b.Program.prototype.startTick=function(){var a=this;a.preOrderSalmon(function(a,b){b.justSpawned=!1})},b.Program.prototype.inputTick=function(){var a=this;a.debug("starting input tick #"+a.tickNum),a.endThisTick},b.Program.prototype.tickSnow=function(){var a=this;a.tick(),a.preOrder(function(b){"marshy"==b.name?a.debug(b.name+" -> "+(b.is_snowy?"YES":"-")+(b.prev_snow?" / (YES)":" / (-)")):a.debug(b.name+" -> "+(b.is_snowy?"YES":"-"))})},b.Program.prototype.tickWater=function(){var a=this;a.tick(),a.preOrder(function(b){a.debug(b.name+" -> "+(b.is_watered?"YES":"-"))})},b.Nodes={},b.Nodes.append_down={},b.Nodes.append_up={},b.Nodes.bear={onMiscTick:function(){this.filterSalmon(function(a,c){a.age==b["const"].MATURE?a.dead=!0:c.push(a)})}},b.Nodes.bird={},b.Nodes.bridge={blocksWater:function(){return this.is_destroyed},blocksSnowmelt:function(){return this.is_destroyed},canBeDestroyed:function(){return!0}},b.Nodes.clone={},b.Nodes.current={},b.Nodes.downstream_sense={blocksPower:function(){return this.hasMatureDownstreamSalmon()}},b.Nodes.evaporates={blocksWater:function(){return this.isPowered()},blocksSnowmelt:function(){return this.isPowered()}},b.Nodes.fear={},b.Nodes.force_down={},b.Nodes.force_field={blocksWater:function(){return this.isPowered()},blocksSnowmelt:function(){return this.isPowered()},canFishLeave:function(){return!this.isPowered()}},b.Nodes.force_up={},b.Nodes.hatchery={},b.Nodes.hydro_power={generatesPower:function(){return this.is_watered&&!this.is_destroyed},canBeDestroyed:function(){return!0}},b.Nodes.insulated={blocksPower:function(){return!0}},b.Nodes.inverse_lock={blocksSnowmelt:function(){return!this.isPowered()}},b.Nodes.lock={blocksSnowmelt:function(){return this.isPowered()}},b.Nodes.marshy={},b.Nodes.narrows={},b.Nodes.net={},b.Nodes.oblivion={canBeDestroyed:function(){return!0}},b.Nodes.power_invert={canBeDestroyed:function(){return!0}},b.Nodes.powers={generatesPower:function(){return!0}},b.Nodes.pump={},b.Nodes.range_sense={blocksPower:function(){return this.hasMatureSalmon()||this.hasMatureSalmonUpstream()}},b.Nodes.range_switch={blocksPower:function(){return!this.hasMatureSalmon()&&!this.hasMatureSalmonUpstream()}},b.Nodes.rapids={onFishEnters:function(a){a.age==b["const"].YOUNG&&(a.ready=!1)}},b.Nodes.reverse_down={},b.Nodes.reverse_up={},b.Nodes.sense={blocksPower:function(){return this.hasMatureSalmon()}},b.Nodes.shallows={onFishEnters:function(a){a.age==b["const"].MATURE&&(a.ready=!1)}},b.Nodes.snowmelt={},b.Nodes.spawn={},b.Nodes.split={},b.Nodes["switch"]={blocksPower:function(){return!this.hasMatureSalmon()}},b.Nodes.time={},b.Nodes.universe={canBeDestroyed:function(){return!0}},b.Nodes.upstream_killing_device={},b.Nodes.upstream_sense={blocksPower:function(){return this.hasMatureUpstreamSalmon()}},b.Nodes.waterfall={},b.Nodes.young_bear={},b.Nodes.young_range_sense={blocksPower:function(){return this.hasYoungSalmon()||this.hasYoungSalmonUpstream()}},b.Nodes.young_range_switch={blocksPower:function(){return!this.hasYoungSalmon()&&!this.hasYoungSalmonUpstream()}},b.Nodes.young_sense={blocksPower:function(){return this.hasYoungSalmon()}},b.Nodes.young_switch={blocksPower:function(){return!this.hasYoungSalmon()}},b.Nodes.youth_fountain={},b.NodeDefs={};for(var c in b.Nodes){b.NodeDefs[c]=function(){b.Node.apply(this,arguments)},b.NodeDefs[c].prototype=Object.create(b.Node.prototype);for(var d in b.Nodes[c])b.NodeDefs[c].prototype[d]=b.Nodes[c][d]}"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=b),exports.HS=b):"function"==typeof define&&define.amd?define(function(){return b}):a.HS=b}).call(function(){return this||("undefined"!=typeof window?window:global)}());