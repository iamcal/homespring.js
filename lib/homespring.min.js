/*! homespring.js 2017-01-08 */
var HS={};HS["const"]={YOUNG:1,MATURE:2,UPSTREAM:3,DOWNSTREAM:4},HS.Exception=function(a){this.message=a,this.name="HS.Exception"},HS.Program=function(a,b){var c=this;return c.debugMode=!!b,c.tokens=c.tokenize(a),c.nodes=c.build_tree(c.tokens),c.root=c.nodes.length?c.nodes[0]:null,c.tickNum=0,c.endThisTick=!1,c},HS.Program.prototype.build_tree=function(a){var b=this;if(!a.length)return[];for(var c=1,d=b.create_node(c++,a[0]),e=d,f=[d],g=1;g<a.length;g++)if(""==a[g]){if(e=e.parent,!e)throw new HS.Exception("Illegal program - traversed beyond root")}else{var h=b.create_node(c++,a[g],e);f.push(h),e=h}return f},HS.Program.prototype.create_node=function(a,b,c){var d=b.toLowerCase().replace(/ /g,"_");return HS.NodeDefs[d]?new HS.NodeDefs[d](a,b,c):new HS.SpringNode(a,b,c)},HS.Node=function(a,b,c){var d=this;return d.uid=a,d.name=b,d.lname=b.toLowerCase(),d.parent=c,d.kids=[],d.salmon=[],c&&c.kids.push(d),d.is_snowy=null,d.is_watered=null,d.generates_power=null,d.is_destroyed=!1,d.prev_snow=!1,d},HS.Node.prototype.generatesPower=function(){return!1},HS.Node.prototype.blocksPower=function(){return!1},HS.Node.prototype.blocksWater=function(){return!1},HS.Node.prototype.blocksSnowmelt=function(){return!1},HS.Node.prototype.canFishLeave=function(a){return!0},HS.Node.prototype.canFishEnter=function(a){return!0},HS.Node.prototype.canBeDestroyed=function(){return!1},HS.Node.prototype.isSpring=function(){return!1},HS.Node.prototype.onFishEnters=function(a){},HS.Node.prototype.onMiscTick=function(){},HS.Node.prototype.isPowered=function(){var a=this;if(a.generates_power)return!0;if(a.blocksPower())return!1;if("power invert"==a.lname){for(var b=0;b<a.kids;b++)if(a.kids[b].isPowered())return!1;return!0}for(var b=0;b<a.kids.length;b++)if(a.kids[b].isPowered())return!0;return!1},HS.Node.prototype.fishEnters=function(a){var b=this;b.onFishEnters(a),b.salmon.unshift(a)},HS.Node.prototype.canFindNamedNode=function(a){var b=this;if(b.name==a)return!0;for(var c=0;c<b.kids.length;c++)if(b.kids[c].canFindNamedNode(a))return!0;return!1},HS.Node.prototype.filterSalmon=function(a){for(var b=[],c=0;c<this.salmon.length;c++)a(this.salmon[c],b);this.salmon=b},HS.SpringNode=function(){HS.Node.apply(this,arguments)},HS.SpringNode.prototype=Object.create(HS.Node.prototype),HS.SpringNode.prototype.isSpring=function(){return!0},HS.Salmon=function(a,b,c,d){var e=this;return e.program=a,e.name=b,e.age=c,e.direction=d,e.justSpawned=!1,e.spawnChild=null,e.ready=!0,e},HS.Salmon.prototype.spawn=function(){var a=this;a.age=HS["const"].MATURE,a.direction=HS["const"].DOWNSTREAM;var b=new HS.Salmon(a.program,a.name,HS["const"].YOUNG,HS["const"].DOWNSTREAM);return a.justSpawned=!0,a.spawnChild=b,b},HS.Program.prototype.debug=function(a){var b=this;b.debugMode&&console.log(a)},HS.Program.prototype.tokenize=function(a){var b=this;if(a.indexOf("\t")>=0)throw new HS.Exception("Illegal program - contains tabs");if(a.indexOf(" . ")>=0)throw new HS.Exception("Illegal program - contains space-dot-space");if(a.indexOf(". .")>=0)throw new HS.Exception("Illegal program - contains dot-space-dot");for(var c=[],d=a.split(""),e="",f=d.length,g=0;g<f;g++)if(" "==d[g])"."==d[g+1]?(e+=".",g++):(c.push(e),e="");else if("\n"==d[g])c.push(e),e="";else if("."==d[g])if(" "==d[g+1])e+=" ",g++;else{if("\n"!=d[g+1])return b.debug("parser error - unexpected period followewd by "+d[g+1]),[];e+="\n",c.push(e),e="",g++}else e+=d[g];return e.length&&c.push(e),c},HS.Program.prototype.run=function(a){for(var b=this,c=a||10,d=0;d<c&&!b.endThisTick;)b.tick(),d++;b.endThisTick?b.debug("program terminated"):b.debug("stopped run after "+d+" ticks")},HS.Program.prototype.tick=function(){var a=this;a.tickNum++,a.startTick(),a.snowTick(),a.waterTick(),a.powerTick(),a.fishTick(),a.miscTick(),a.inputTick()},HS.Program.prototype.snowTick=function(){var a=this;a.debug("starting snow tick #"+a.tickNum),a.postOrder(function(b){if("snowmelt"==b.lname)return void(b.is_snowy=!0);for(var c=!1,d=0;d<b.kids.length;d++)if(b.kids[d].is_snowy){c=!0;break}return"marshy"==b.lname?(b.is_snowy=b.prev_snow,void(b.prev_snow=c)):c?b.blocksSnowmelt()?void(b.is_snowy=!1):(b.is_snowy=!0,"universe"==b.lname&&(a.endThisTick=!0),void(b.canBeDestroyed()&&(b.old_name=b.name,b.old_lname=b.lname,b.name="",b.lname="",b.is_destroyed=!0))):void(b.is_snowy=!1)})},HS.Program.prototype.waterTick=function(){var a=this;a.debug("starting water tick #"+a.tickNum),a.postOrder(function(a){if(a.blocksWater())return void(a.is_watered=!1);if(a.isSpring())return void(a.is_watered=!0);for(var b=0;b<a.kids.length;b++)if(a.kids[b].is_watered)return void(a.is_watered=!0);a.is_watered=!1})},HS.Program.prototype.powerTick=function(){var a=this;a.debug("starting power tick #"+a.tickNum),a.preOrder(function(a){a.generates_power=a.generatesPower()})},HS.Program.prototype.fishTick=function(){var a=this;a.debug("starting fish tick #"+a.tickNum),a.fishTickDown(),a.fishTickUp(),a.fishTickHatch()},HS.Program.prototype.fishTickDown=function(){var a=this;a.debug("starting fish tick down #"+a.tickNum),a.preOrder(function(b){b.filterSalmon(function(c,d){return c.direction!=HS["const"].DOWNSTREAM?void d.push(c):c.ready?b.canFishLeave(c)?b.parent?b.parent.canFishEnter(c)?void b.parent.fishEnters(c):void d.push(c):void a.debug("salmon made it out to world: "+c.name):void d.push(c):(d.push(c),void(c.ready=!0))})})},HS.Program.prototype.fishTickUp=function(){var a=this;a.debug("starting fish tick up #"+a.tickNum),a.postOrder(function(a){a.filterSalmon(function(b,c){if(b.direction!=HS["const"].UPSTREAM)return void c.push(b);if(!b.ready)return c.push(b),void(b.ready=!0);if(!a.canFishLeave(b))return c.push(b),void c.push(b.spawn());for(var d=0;d<a.kids.length;d++)if(a.kids[d].canFindNamedNode(b.name)&&a.kids[d].canFishEnter(b))return void a.kids[d].fishEnters(b);for(var d=0;d<a.kids.length;d++)if(a.kids[d].canFishEnter(b))return void a.kids[d].fishEnters(b);c.push(b),c.push(b.spawn())})})},HS.Program.prototype.fishTickHatch=function(){var a=this;a.debug("starting fish tick hatch #"+a.tickNum),a.preOrder(function(b){if("hatchery"==b.lname&&b.isPowered()){var c=new HS.Salmon(a,"homeless",HS["const"].MATURE,HS["const"].UPSTREAM);b.salmon.unshift(c)}})},HS.Program.prototype.preOrder=function(a){for(var b=this,c=0;c<b.nodes.length;c++)a(b.nodes[c])},HS.Program.prototype.postOrder=function(a){for(var b=this,c=b.nodes.length-1;c>=0;c--)a(b.nodes[c])},HS.Program.prototype.preOrderSalmon=function(a){var b=this;b.preOrder(function(b){for(var c=0;c<b.salmon.length;c++)a(b,b.salmon[c])})},HS.Program.prototype.dumpFish=function(){var a=this;a.preOrderSalmon(function(b,c){var d="?",e="?";c.age==HS["const"].YOUNG&&(d="young"),c.age==HS["const"].MATURE&&(d="mature"),c.direction==HS["const"].UPSTREAM&&(e="upstream"),c.direction==HS["const"].DOWNSTREAM&&(e="downstream"),a.debug("node "+b.lname+': salmon "'+c.name+'", '+d+", "+e)})},HS.Program.prototype.miscTick=function(){var a=this;a.debug("starting misc tick #"+a.tickNum),a.endThisTick&&a.debug("program exits!"),a.preOrder(function(a){a.onMiscTick()})},HS.Program.prototype.startTick=function(){var a=this;a.preOrderSalmon(function(a,b){b.justSpawned=!1})},HS.Program.prototype.inputTick=function(){var a=this;a.debug("starting input tick #"+a.tickNum),a.endThisTick},HS.Program.prototype.tickSnow=function(){var a=this;a.tick(),a.preOrder(function(b){"marshy"==b.name?a.debug(b.name+" -> "+(b.is_snowy?"YES":"-")+(b.prev_snow?" / (YES)":" / (-)")):a.debug(b.name+" -> "+(b.is_snowy?"YES":"-"))})},HS.Program.prototype.tickWater=function(){var a=this;a.tick(),a.preOrder(function(b){a.debug(b.name+" -> "+(b.is_watered?"YES":"-"))})},HS.Nodes={},HS.Nodes.append_down={},HS.Nodes.append_up={},HS.Nodes.bear={onMiscTick:function(){this.filterSalmon(function(a,b){a.age==HS["const"].MATURE?a.dead=!0:b.push(a)})}},HS.Nodes.bird={},HS.Nodes.bridge={blocksWater:function(){return this.is_destroyed},blocksSnowmelt:function(){return this.is_destroyed},canBeDestroyed:function(){return!0}},HS.Nodes.clone={},HS.Nodes.current={},HS.Nodes.downstream_sense={blocksPower:function(){return this.hasMatureDownstreamSalmon()}},HS.Nodes.evaporates={blocksWater:function(){return this.isPowered()},blocksSnowmelt:function(){return this.isPowered()}},HS.Nodes.fear={},HS.Nodes.force_down={},HS.Nodes.force_field={blocksWater:function(){return this.isPowered()},blocksSnowmelt:function(){return this.isPowered()},canFishLeave:function(){return!this.isPowered()}},HS.Nodes.force_up={},HS.Nodes.hatchery={},HS.Nodes.hydro_power={generatesPower:function(){return this.is_watered&&!this.is_destroyed},canBeDestroyed:function(){return!0}},HS.Nodes.insulated={blocksPower:function(){return!0}},HS.Nodes.inverse_lock={blocksSnowmelt:function(){return!this.isPowered()}},HS.Nodes.lock={blocksSnowmelt:function(){return this.isPowered()}},HS.Nodes.marshy={},HS.Nodes.narrows={},HS.Nodes.net={},HS.Nodes.oblivion={canBeDestroyed:function(){return!0}},HS.Nodes.power_invert={canBeDestroyed:function(){return!0}},HS.Nodes.powers={generatesPower:function(){return!0}},HS.Nodes.pump={},HS.Nodes.range_sense={blocksPower:function(){return this.hasMatureSalmon()||this.hasMatureSalmonUpstream()}},HS.Nodes.range_switch={blocksPower:function(){return!this.hasMatureSalmon()&&!this.hasMatureSalmonUpstream()}},HS.Nodes.rapids={onFishEnters:function(a){a.age==HS["const"].YOUNG&&(a.ready=!1)}},HS.Nodes.reverse_down={},HS.Nodes.reverse_up={},HS.Nodes.sense={blocksPower:function(){return this.hasMatureSalmon()}},HS.Nodes.shallows={onFishEnters:function(a){a.age==HS["const"].MATURE&&(a.ready=!1)}},HS.Nodes.snowmelt={},HS.Nodes.spawn={},HS.Nodes.split={},HS.Nodes["switch"]={blocksPower:function(){return!this.hasMatureSalmon()}},HS.Nodes.time={},HS.Nodes.universe={canBeDestroyed:function(){return!0}},HS.Nodes.upstream_killing_device={},HS.Nodes.upstream_sense={blocksPower:function(){return this.hasMatureUpstreamSalmon()}},HS.Nodes.waterfall={},HS.Nodes.young_bear={},HS.Nodes.young_range_sense={blocksPower:function(){return this.hasYoungSalmon()||this.hasYoungSalmonUpstream()}},HS.Nodes.young_range_switch={blocksPower:function(){return!this.hasYoungSalmon()&&!this.hasYoungSalmonUpstream()}},HS.Nodes.young_sense={blocksPower:function(){return this.hasYoungSalmon()}},HS.Nodes.young_switch={blocksPower:function(){return!this.hasYoungSalmon()}},HS.Nodes.youth_fountain={},HS.NodeDefs={};for(var i in HS.Nodes){HS.NodeDefs[i]=function(){HS.Node.apply(this,arguments)},HS.NodeDefs[i].prototype=Object.create(HS.Node.prototype);for(var j in HS.Nodes[i])HS.NodeDefs[i].prototype[j]=HS.Nodes[i][j]}