/*! homespring.js 2017-05-09 */
"use strict";(function(){var a=this,b={};b["const"]={YOUNG:1,MATURE:2,UPSTREAM:3,DOWNSTREAM:4},b.Exception=function(a){this.message=a,this.name="HS.Exception"},b.Program=function(a,b){var c=this;return b||(b={}),c.options={strictMode:!!b.strictMode,traceTicks:!!b.traceTicks},c.nodesUsed={},c.tokens=c.tokenize(a),c.nodes=c.build_tree(c.tokens),c.root=c.nodes.length?c.nodes[0]:null,c.preOrderList=[],c.root&&c.preOrderPopulate(c.root),c.postOrderList=[],c.root&&c.postOrderPopulate(c.root),c.endThisTick=!1,c.salmon_uid=1,c.tickNum=0,c.terminated=!1,c.input=null,c},b.Program.prototype.build_tree=function(a){var c=this;if(!a.length)return[];for(var d=1,e=c.create_node(d++,a[0]),f=e,g=[e],h=1;h<a.length;h++)if(""==a[h])if(f.parent)f=f.parent;else{if(c.options.strictMode)throw new b.Exception("Illegal program - traversed beyond root");var i=c.create_node(d++,"",f);g.push(i),f=i}else{var i=c.create_node(d++,a[h],f);g.push(i),f=i}return g},b.Program.prototype.create_node=function(a,c,d){var e=c.toLowerCase().replace(/ /g,"_");return b.NodeDefs[e]?(this.nodesUsed[e]=1,new b.NodeDefs[e](this,a,c,d)):new b.SpringNode(this,a,c,d)},b.Program.prototype.preOrderPopulate=function(a){this.preOrderList.push(a);for(var b=0;b<a.kids.length;b++)this.preOrderPopulate(a.kids[b])},b.Program.prototype.postOrderPopulate=function(a){for(var b=0;b<a.kids.length;b++)this.postOrderPopulate(a.kids[b]);this.postOrderList.push(a)},b.Program.prototype.onOutput=function(a){},b.Program.prototype.onTerminate=function(){},b.Node=function(a,b,c,d){var e=this;return e.program=a,e.uid=b,e.name=c,e.lname=c.toLowerCase(),e.parent=d,e.kids=[],e.salmon=[],e.born=[],d&&(d.kids.push(e),e.childIndex=d.kids.length),e.is_snowy=null,e.is_watered=null,e.generates_power=null,e.is_destroyed=!1,e.prev_snow=!1,e},b.Node.prototype.toString=function(){var a="";return this.is_destroyed&&(a+=":destroyed"),this.generates_power&&(a+=":P"),this.isPowered()&&(a+=":p"),this.is_snowy&&(a+=":s"),this.is_watered&&(a+=":w"),this.blocksPower()&&(a+=":BP"),this.blocksWater()&&(a+=":BW"),this.blocksSnowmelt()&&(a+=":BS"),this.safeName()+a},b.Node.prototype.safeName=function(){return this.name.replace(/\n/g,"\\n")},b.Node.prototype.generatesPower=function(){return!1},b.Node.prototype.blocksPower=function(){return!1},b.Node.prototype.blocksWater=function(){return!1},b.Node.prototype.blocksSnowmelt=function(){return!1},b.Node.prototype.canFishLeave=function(a){return!0},b.Node.prototype.canFishLeaveFor=function(a,b){return!0},b.Node.prototype.canFishEnter=function(a){return!0},b.Node.prototype.canBeDestroyed=function(){return!1},b.Node.prototype.onFishEnters=function(a){},b.Node.prototype.onMiscTick=function(){},b.Node.prototype.fishHatchTick=function(){},b.Node.prototype.isPowered=function(){var a=this;if(a.generates_power)return!0;if(a.blocksPower())return!1;for(var b=0;b<a.kids.length;b++)if(a.kids[b].isPowered())return!0;return!1},b.Node.prototype.waterTick=function(){var a=this;if(a.is_watered=!1,!a.blocksWater())for(var b=0;b<a.kids.length;b++)if(a.kids[b].is_watered)return void(a.is_watered=!0)},b.Node.prototype.snowTick=function(){var a=this;return a.hasSnowyChildren()?a.blocksSnowmelt()?void(a.is_snowy=!1):(a.is_snowy=!0,void(!a.is_destroyed&&a.canBeDestroyed()&&(a.program.debug("destroying node "+a),a.is_destroyed=!0))):void(a.is_snowy=!1)},b.Node.prototype.fishTickEnd=function(){var a=this;a.salmon=a.born.concat(a.salmon),a.born=[]},b.Node.prototype.hasSnowyChildren=function(){for(var a=0;a<this.kids.length;a++)if(this.kids[a].is_snowy)return!0;return!1},b.Node.prototype.fishEnters=function(a){var b=this;b.onFishEnters(a),b.salmon.unshift(a)},b.Node.prototype.canFindNamedNode=function(a){var b=this;if(b.name==a)return!0;for(var c=0;c<b.kids.length;c++)if(b.kids[c].canFindNamedNode(a))return!0;return!1},b.Node.prototype.filterSalmon=function(a){for(var b=[],c=0;c<this.salmon.length;c++)a(this.salmon[c],b);this.salmon=b},b.Node.prototype.matchSalmon=function(a){for(var b=0;b<this.salmon.length;b++)if(a(this.salmon[b]))return!0;return!1},b.Node.prototype.matchSalmonUpstream=function(a){for(var b=0;b<this.salmon.length;b++)if(a(this.salmon[b]))return!0;for(var b=0;b<this.kids.length;b++)if(this.kids[b].matchSalmonUpstream(a))return!0;return!1},b.Node.prototype.spawnAllUpstream=function(){var a=this;a.filterSalmon(function(b,c){b.spawn(a),c.push(b)});for(var b=0;b<a.kids.length;b++)a.kids[b].spawnAllUpstream();a.fishTickEnd()},b.SpringNode=function(){b.Node.apply(this,arguments)},b.SpringNode.prototype=Object.create(b.Node.prototype),b.SpringNode.prototype.waterTick=function(){this.is_watered=!0},b.Salmon=function(a,b,c,d,e){var f=this;return f.program=a,f.uid=a.salmon_uid++,f.name=b,f.age=c,f.direction=d,f.childFrom=e,f.justSpawned=!1,f.spawnChild=null,f.ready=!0,f.dead=!1,f},b.Salmon.prototype.safeName=function(){return this.name.replace(/\n/g,"\\n")},b.Salmon.prototype.toString=function(){var a="";this.direction==b["const"].DOWNSTREAM&&(a=":down"),this.direction==b["const"].UPSTREAM&&(a=":up");var c="";return this.age==b["const"].YOUNG&&(c=":young"),this.age==b["const"].MATURE&&(c=":mature"),this.safeName()+c+a},b.Salmon.prototype.spawn=function(a){var c=this,d=new b.Salmon(c.program,a.name,b["const"].YOUNG,b["const"].DOWNSTREAM,1);return a.born.unshift(d),c.age=b["const"].MATURE,c.direction=b["const"].DOWNSTREAM,c.justSpawned=!0,c.spawnChild=d,d},b.Program.prototype.debug=function(a){var b=this;b.options.traceTicks&&console.log(a)},b.Program.prototype.tokenize=function(a){var c=this;if(a.indexOf("\t")>=0)throw new b.Exception("Illegal program - contains tabs");if(a.indexOf(" . ")>=0)throw new b.Exception("Illegal program - contains space-dot-space");if(a.indexOf(". .")>=0)throw new b.Exception("Illegal program - contains dot-space-dot");for(var d=[],e=a.split(""),f="",g=e.length,h=0;h<g;h++)if(" "==e[h])"."==e[h+1]&&""!=f?(f+=".",h++):(d.push(f),f="");else if("\n"==e[h])d.push(f),f="";else if("."==e[h])if(" "==e[h+1])f+=" ",h++;else if("\n"==e[h+1])f+="\n",d.push(f),f="",h++;else{if("."!=e[h+1])return c.debug("parser error - unexpected period followewd by "+e[h+1]),[];d.push(f),f=""}else f+=e[h];return f.length&&d.push(f),d},b.Program.prototype.run=function(a){var b=this;b.maxTicks=a,this.intervalId=setInterval(b.tick.bind(b),0)},b.Program.prototype.runSync=function(a){var b=this;b.maxTicks=a;var c=b.onOutput,d="";for(b.onOutput=function(){return function(a){d+=a,c(a)}}();!b.terminated;)b.tick();return b.onOutput=c,d},b.Program.prototype.tick=function(){var a=this;if(!a.terminated){if(!a.root)return a.onOutput("In Homespring, the null program is not a quine.\n"),void a.terminate();if(void 0!=a.maxTicks&&a.tickNum>=a.maxTicks)return a.debug("stopped run after maxTicks ("+a.maxTicks+") ticks"),void a.terminate();if(a.endThisTick)return void a.terminate();a.tickNum++,a.onTickStart&&a.onTickStart(),a.startTick(),a.snowTick(),a.waterTick(),a.powerTick(),a.fishTick(),a.miscTick(),a.endThisTick||a.inputTick(),a.onTickEnd&&a.onTickEnd(),a.endThisTick&&a.terminate()}},b.Program.prototype.terminate=function(){var a=this;a.terminated=!0,void 0!=a.intervalId&&(clearInterval(this.intervalId),a.intervalId=void 0),a.onTerminate()},b.Program.prototype.snowTick=function(){var a=this;a.debug("starting snow tick #"+a.tickNum),a.preOrder(function(a){a.snowTick()})},b.Program.prototype.waterTick=function(){var a=this;a.debug("starting water tick #"+a.tickNum),a.preOrder(function(a){a.waterTick()})},b.Program.prototype.powerTick=function(){var a=this;a.debug("starting power tick #"+a.tickNum),a.preOrder(function(a){a.generates_power=a.generatesPower()})},b.Program.prototype.fishTick=function(){var a=this;a.debug("starting fish tick #"+a.tickNum),a.fishTickDown(),a.fishTickUp(),a.fishTickHatch(),a.fishTickEnd()},b.Program.prototype.fishTickDown=function(){var a=this;a.debug("starting fish tick down #"+a.tickNum),a.preOrder(function(c){c.filterSalmon(function(d,e){return d.direction!=b["const"].DOWNSTREAM?void e.push(d):d.ready?c.canFishLeave(d)?c.parent?c.parent.canFishEnter(d)?(d.childFrom=c.childIndex,void c.parent.fishEnters(d)):void e.push(d):void a.onOutput(d.name,d):void e.push(d):(e.push(d),void(d.ready=!0))})})},b.Program.prototype.fishTickUp=function(){var a=this;a.debug("starting fish tick up #"+a.tickNum),a.postOrder(function(a){a.filterSalmon(function(c,d){if(c.direction!=b["const"].UPSTREAM)return void d.push(c);if(!c.ready)return d.push(c),void(c.ready=!0);if(a.name==c.name)return c.spawn(a),void d.push(c);if(!a.canFishLeave(c))return c.spawn(a),void d.push(c);for(var e=0;e<a.kids.length;e++)if(a.kids[e].canFindNamedNode(c.name)&&a.kids[e].canFishEnter(c)&&a.canFishLeaveFor(c,a.kids[e]))return void a.kids[e].fishEnters(c);for(var e=0;e<a.kids.length;e++)if(a.kids[e].canFishEnter(c)&&a.canFishLeaveFor(c,a.kids[e]))return c.childFrom=0,void a.kids[e].fishEnters(c);c.spawn(a),d.push(c)})})},b.Program.prototype.fishTickHatch=function(){var a=this;a.debug("starting fish tick hatch #"+a.tickNum),a.preOrder(function(a){a.fishHatchTick()})},b.Program.prototype.fishTickEnd=function(){var a=this;a.preOrder(function(a){a.fishTickEnd()})},b.Program.prototype.preOrder=function(a){for(var b=this,c=0;c<b.preOrderList.length;c++)a(b.preOrderList[c])},b.Program.prototype.postOrder=function(a){for(var b=this,c=0;c<b.postOrderList.length;c++)a(b.postOrderList[c])},b.Program.prototype.preOrderSalmon=function(a){var b=this;b.preOrder(function(b){for(var c=0;c<b.salmon.length;c++)a(b,b.salmon[c])})},b.Program.prototype.dumpFish=function(){var a=this;a.preOrderSalmon(function(b,c){a.debug(b+" - "+c)})},b.Program.prototype.miscTick=function(){var a=this;a.debug("starting misc tick #"+a.tickNum),a.preOrder(function(a){a.onMiscTick()})},b.Program.prototype.startTick=function(){var a=this;a.preOrderSalmon(function(a,b){b.justSpawned=!1})},b.Program.prototype.inputTick=function(){var a=this;if(a.debug("starting input tick #"+a.tickNum),null!=a.input&&void 0!=a.input){var c=new b.Salmon(a,a.input,b["const"].MATURE,b["const"].UPSTREAM,1);a.root.fishEnters(c),a.input=null}},b.Program.prototype.dumpState=function(){var a=this;console.log(""),console.log("## World state after tick "+a.tickNum);for(var b=0;b<a.nodes.length;b++){for(var c=a.nodes[b],d=0,e=c;e.parent;)d++,e=e.parent;for(var f=[],g=0;g<c.salmon.length;g++)f.push(c.salmon[g].toString());f="["+f.join(",")+"]",console.log("  ".repeat(d)+a.nodes[b].toString()+f)}},b.Nodes={},b.Nodes.append_down={onMiscTick:function(){for(var a=this,c=[],d="",e=0;e<a.salmon.length;e++)a.salmon[e].direction==b["const"].DOWNSTREAM&&1!=a.salmon[e].childFrom?(d+=a.salmon[e].name,a.salmon[e].dead=!0):c.push(a.salmon[e]);for(var e=0;e<c.length;e++)c[e].direction==b["const"].DOWNSTREAM&&(c[e].name+=d);a.salmon=c}},b.Nodes.append_up={onMiscTick:function(){var a=this;a.filterSalmon(function(c,d){if(c.direction==b["const"].DOWNSTREAM&&1!=c.childFrom){c.dead=!0;for(var e=0;e<a.salmon.length;e++)a.salmon[e].direction==b["const"].UPSTREAM&&(a.salmon[e].name+=c.name)}else d.push(c)})}},b.Nodes.bear={onMiscTick:function(){this.filterSalmon(function(a,c){a.age==b["const"].MATURE?a.dead=!0:c.push(a)})}},b.Nodes.bird={onMiscTick:function(){this.filterSalmon(function(a,c){a.age==b["const"].YOUNG?a.dead=!0:c.push(a)})}},b.Nodes.bridge={blocksWater:function(){return this.is_destroyed},blocksSnowmelt:function(){return this.is_destroyed},canFishEnter:function(a){return!this.is_destroyed},canBeDestroyed:function(){return!0}},b.Nodes.clone={onMiscTick:function(){for(var a=this.salmon.length,c=0;c<a;c++)this.salmon.push(new b.Salmon(this.program,this.salmon[c].name,b["const"].YOUNG,b["const"].DOWNSTREAM,1))}},b.Nodes.current={canFishEnter:function(a){return a.age!=b["const"].YOUNG}},b.Nodes.downstream_sense={blocksPower:function(){return this.matchSalmon(function(a){return a.age==b["const"].MATURE&&a.direction==b["const"].DOWNSTREAM})}},b.Nodes.evaporates={blocksWater:function(){return this.isPowered()},blocksSnowmelt:function(){return this.isPowered()}},b.Nodes.fear={canFishEnter:function(){return!this.isPowered()}},b.Nodes.force_down={canFishLeaveFor:function(a,b){return b.childIndex!=this.kids.length}},b.Nodes.force_field={blocksWater:function(){return this.isPowered()},blocksSnowmelt:function(){return this.isPowered()},canFishLeave:function(){return!this.isPowered()}},b.Nodes.force_up={canFishLeaveFor:function(a,b){return 1!=b.childIndex}},b.Nodes.hatchery={canBeDestroyed:function(){return!0},fishHatchTick:function(){if(this.isPowered()&&!this.is_destroyed){var a=new b.Salmon(this,"homeless",b["const"].YOUNG,b["const"].UPSTREAM,1);this.born.unshift(a)}}},b.Nodes.hydro_power={generatesPower:function(){return this.is_watered&&!this.is_destroyed},canBeDestroyed:function(){return!0}},b.Nodes.insulated={blocksPower:function(){return!0}},b.Nodes.inverse_lock={blocksSnowmelt:function(){return!this.isPowered()},canFishEnter:function(a){return this.isPowered()||a.direction!=b["const"].DOWNSTREAM}},b.Nodes.lock={blocksSnowmelt:function(){return this.isPowered()},canFishEnter:function(a){return!(this.isPowered()&&a.direction==b["const"].DOWNSTREAM)}},b.Nodes.marshy={snowTick:function(){this.is_snowy=this.prev_snow,this.prev_snow=this.hasSnowyChildren()}},b.Nodes.narrows={canFishEnter:function(a){return 0==this.salmon.length}},b.Nodes.net={canFishEnter:function(a){return a.age!=b["const"].MATURE}},b.Nodes.oblivion={canBeDestroyed:function(){return!0},onMiscTick:function(){this.isPowered()&&!this.is_destroyed&&this.filterSalmon(function(a,b){a.name="",b.push(a)})}},b.Nodes.power_invert={canBeDestroyed:function(){return!0},isPowered:function(){var a=this;if(a.is_destroyed)return b.Node.prototype.isPowered.apply(a);for(var c=0;c<a.kids.length;c++)if(a.kids[c].isPowered())return!1;return!0}},b.Nodes.powers={generatesPower:function(){return!0}},b.Nodes.pump={canFishEnter:function(a){return this.isPowered()}},b.Nodes.range_sense={blocksPower:function(){return this.matchSalmonUpstream(function(a){return a.age==b["const"].MATURE})}},b.Nodes.range_switch={blocksPower:function(){return!this.matchSalmonUpstream(function(a){return a.age==b["const"].MATURE})}},b.Nodes.rapids={onFishEnters:function(a){a.age==b["const"].YOUNG&&(a.ready=!1)}},b.Nodes.reverse_down={onMiscTick:function(){var a=this;a.kids.length<2||a.filterSalmon(function(c,d){c.direction==b["const"].DOWNSTREAM&&1==c.childFrom?(c.direction=b["const"].UPSTREAM,a.kids[1].canFishEnter(c)?a.kids[1].fishEnters(c):(c.direction=b["const"].DOWNSTREAM,d.push(c))):d.push(c)})}},b.Nodes.reverse_up={onMiscTick:function(){var a=this;a.kids.length<2||this.filterSalmon(function(c,d){c.direction==b["const"].DOWNSTREAM&&2==c.childFrom?(c.direction=b["const"].UPSTREAM,a.kids[0].canFishEnter(c)?a.kids[0].fishEnters(c):(c.direction=b["const"].DOWNSTREAM,d.push(c))):d.push(c)})}},b.Nodes.sense={blocksPower:function(){return this.matchSalmon(function(a){return a.age==b["const"].MATURE})}},b.Nodes.shallows={onFishEnters:function(a){a.age==b["const"].MATURE&&(a.ready=!1)}},b.Nodes.snowmelt={snowTick:function(){this.is_snowy=!0}},b.Nodes.spawn={onMiscTick:function(){this.isPowered()&&this.spawnAllUpstream()}},b.Nodes.split={onMiscTick:function(){var a=this;this.filterSalmon(function(c,d){c.dead=!0;for(var e=c.name.split(""),f=0;f<e.length;f++)a.born.push(new b.Salmon(a.program,e[f],c.age,c.direction,c.childFrom))}),a.salmon=a.born,a.born=[]}},b.Nodes["switch"]={blocksPower:function(){return!this.matchSalmon(function(a){return a.age==b["const"].MATURE})}},b.Nodes.time={onMiscTick:function(){this.filterSalmon(function(a,c){a.age=b["const"].MATURE,c.push(a)})}},b.Nodes.universe={canBeDestroyed:function(){return!0},onMiscTick:function(){this.is_destroyed&&(this.program.endThisTick=!0,this.program.debug("universe has been destroyed - program exits!"))}},b.Nodes.upstream_killing_device={onMiscTick:function(){this.isPowered()&&this.kids.length>1&&this.kids[this.kids.length-1].filterSalmon(function(a,b){a.dead=!0})}},b.Nodes.upstream_sense={blocksPower:function(){return this.matchSalmon(function(a){return a.age==b["const"].MATURE&&a.direction==b["const"].UPSTREAM})}},b.Nodes.waterfall={},b.Nodes.young_bear={onMiscTick:function(){for(var a=this,c=[],d=[],e=!1,f=0;f<a.salmon.length;f++)a.salmon[f].age==b["const"].MATURE?(e?a.salmon[f].dead=!0:d.push(a.salmon[f]),e=!e):c.push(a.salmon[f]);a.salmon=c.concat(d)}},b.Nodes.young_range_sense={blocksPower:function(){return this.matchSalmonUpstream(function(a){return a.age==b["const"].YOUNG})}},b.Nodes.young_range_switch={blocksPower:function(){return!this.matchSalmonUpstream(function(a){return a.age==b["const"].YOUNG})}},b.Nodes.young_sense={blocksPower:function(){return this.matchSalmon(function(a){return a.age==b["const"].YOUNG})}},b.Nodes.young_switch={blocksPower:function(){return!this.matchSalmon(function(a){return a.age==b["const"].YOUNG})}},b.Nodes.youth_fountain={onMiscTick:function(){this.filterSalmon(function(a,c){a.age=b["const"].YOUNG,c.push(a)})}},b.Nodes.force_down.onMiscTick=b.Nodes.reverse_down.onMiscTick,b.Nodes.force_up.onMiscTick=b.Nodes.reverse_up.onMiscTick,b.NodeDefs={};for(var c in b.Nodes){b.NodeDefs[c]=function(){b.Node.apply(this,arguments)},b.NodeDefs[c].prototype=Object.create(b.Node.prototype);for(var d in b.Nodes[c])b.NodeDefs[c].prototype[d]=b.Nodes[c][d]}"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=b),exports.HS=b):"function"==typeof define&&define.amd?define(function(){return b}):a.HS=b}).call(function(){return this||("undefined"!=typeof window?window:global)}());