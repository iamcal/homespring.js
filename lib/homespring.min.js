/*! homespring.js 2017-01-07 */
var HS={};HS["const"]={YOUNG:1,MATURE:2,UPSTREAM:3,DOWNSTREAM:4},HS.Exception=function(a){this.message=a,this.name="HS.Exception"},HS.Program=function(a,b){var c=this;return c.debugMode=!!b,c.tokens=c.tokenize(a),c.tree=c.build_tree(c.tokens),c.tickNum=0,c.endThisTick=!1,c},HS.Program.prototype.build_tree=function(a){var b=this;if(!a.length)return null;for(var c=1,d=b.create_node(c++,a[0]),e=d,f=[d],g=1;g<a.length;g++)if(""==a[g]){if(e=e.parent,!e)throw new HS.Exception("Illegal program - traversed beyond root")}else{var h=b.create_node(c++,a[g],e);f.push(h),e=h}return{root:d,nodes:f}},HS.Program.prototype.create_node=function(a,b,c){var d=b.toLowerCase().replace(/ /g,"_");return HS.NodeDefs[d]?new HS.NodeDefs[d](a,b,c):new HS.Node(a,b,c)},HS.Program.prototype.reservedList={hatchery:1,"hydro power":1,snowmelt:1,shallows:1,rapids:1,"append down":1,bear:1,"force field":1,sense:1,clone:1,"young bear":1,bird:1,"upstream killing device":1,waterfall:1,universe:1,powers:1,marshy:1,insulated:1,"upstream sense":1,"downstream sense":1,evaporates:1,"youth fountain":1,oblivion:1,pump:1,"range sense":1,fear:1,"reverse up":1,"reverse down":1,time:1,lock:1,"inverse lock":1,"young sense":1,"switch":1,"young switch":1,narrows:1,"append up":1,"young range sense":1,net:1,"force down":1,"force up":1,spawn:1,"power invert":1,current:1,bridge:1,split:1,"range switch":1,"young range switch":1},HS.Node=function(a,b,c){var d=this;return d.uid=a,d.name=b,d.lname=b.toLowerCase(),d.parent=c,d.kids=[],d.salmon=[],c&&c.kids.push(d),d.is_snowy=null,d.is_watered=null,d.generates_power=null,d.is_destroyed=!1,d.prev_snow=!1,d.was_bridge=!1,d},HS.Node.prototype.isSpring=function(){var a=this;return!HS.Program.prototype.reservedList[a.lname]},HS.Node.prototype.generatesPower=function(){return!1},HS.Node.prototype.blocksPower=function(){return!1},HS.Node.prototype.blocksWater=function(){return!1},HS.Node.prototype.canFishLeave=function(a){return!0},HS.Node.prototype.canFishEnter=function(a){return!0},HS.Node.prototype.isPowered=function(){var a=this;if(a.generates_power)return!0;if(a.blocksPower())return!1;var b=a.lname;if("power invert"==b){for(var c=0;c<a.kids;c++)if(a.kids[c].isPowered())return!1;return!0}for(var c=0;c<a.kids.length;c++)if(a.kids[c].isPowered())return!0;return!1},HS.Node.prototype.fishEnters=function(a){var b=this;b.salmon.unshift(a)},HS.Salmon=function(a){var b=this;return b.name=a,b.age=null,b.direction=null,b},HS.Program.prototype.debug=function(a){var b=this;b.debugMode&&console.log(a)},HS.Program.prototype.tokenize=function(a){var b=this;if(a.indexOf("\t")>=0)throw new HS.Exception("Illegal program - contains tabs");if(a.indexOf(" . ")>=0)throw new HS.Exception("Illegal program - contains space-dot-space");if(a.indexOf(". .")>=0)throw new HS.Exception("Illegal program - contains dot-space-dot");for(var c=[],d=a.split(""),e="",f=d.length,g=0;g<f;g++)if(" "==d[g])"."==d[g+1]?(e+=".",g++):(c.push(e),e="");else if("\n"==d[g])c.push(e),e="";else if("."==d[g])if(" "==d[g+1])e+=" ",g++;else{if("\n"!=d[g+1])return b.debug("parser error - unexpected period followewd by "+d[g+1]),[];e+="\n",c.push(e),e="",g++}else e+=d[g];return e.length&&c.push(e),c},HS.Program.prototype.run=function(a){for(var b=this,c=a||10,d=0;d<c&&!b.endThisTick;)b.tick(),d++;b.endThisTick?b.debug("program terminated"):b.debug("stopped run after "+d+" ticks")},HS.Program.prototype.tick=function(){var a=this;a.tickNum++,a.snowTick(),a.waterTick(),a.powerTick(),a.fishTick(),a.miscTick(),a.inputTick()},HS.Program.prototype.snowTick=function(){var a=this;a.debug("starting snow tick #"+a.tickNum);var b={"hydro power":1,universe:1,oblivion:1,"power invert":1,bridge:1};a.postOrder(function(c){var d=c.lname;if("snowmelt"==d)return void(c.is_snowy=!0);for(var e=!1,f=0;f<c.kids.length;f++)if(c.kids[f].is_snowy){e=!0;break}return"marshy"==d?(c.is_snowy=c.prev_snow,void(c.prev_snow=e)):e&&("force field"!=d&&"evaporates"!=d&&"lock"!=d||!c.is_powered)&&("inverse lock"!=d||c.is_powered)?""==d&&c.was_bridge?void(c.is_snowy=!1):(c.is_snowy=!0,"universe"==d&&(a.endThisTick=!0),"bridge"==d&&(c.is_destroyed=!0,c.was_bridge=!0),void(b[d]&&(c.old_name=c.name,c.old_lname=c.lname,c.name="",c.lname=""))):void(c.is_snowy=!1)})},HS.Program.prototype.waterTick=function(){var a=this;a.debug("starting water tick #"+a.tickNum),a.postOrder(function(a){a.lname;if(a.isSpring())return void(a.is_watered=!0);for(var b=!1,c=0;c<a.kids.length;c++)if(a.kids[c].is_watered){b=!0;break}return b?a.blocksWater()?void(a.is_watered=!1):void(a.is_watered=!0):void(a.is_watered=!1)})},HS.Program.prototype.powerTick=function(){var a=this;a.debug("starting power tick #"+a.tickNum),a.preOrder(function(a){a.generates_power=a.generatesPower()})},HS.Program.prototype.fishTick=function(){var a=this;a.debug("starting fish tick #"+a.tickNum),a.fishTickDown(),a.fishTickUp(),a.fishTickHatch()},HS.Program.prototype.fishTickDown=function(){var a=this;a.debug("starting fish tick down #"+a.tickNum),a.preOrder(function(b){for(var c=(b.lname,[]),d=0;d<b.salmon.length;d++){var e=b.salmon[d],f=e.direction==HS["const"].DOWNSTREAM;f&&(f=b.canFishLeave(e)),f&&b.parent&&(f=b.parent.canFishEnter(e)),f?b.parent?b.parent.fishEnters(e):a.debug("salmon made it out to world: "+e.name):c.push(e)}b.salmon=c})},HS.Program.prototype.fishTickUp=function(){var a=this;a.debug("starting fish tick up #"+a.tickNum)},HS.Program.prototype.fishTickHatch=function(){var a=this;a.debug("starting fish tick hatch #"+a.tickNum),a.preOrder(function(a){if("hatchery"==a.lname&&a.isPowered()){var b=new HS.Salmon("homeless");b.age=HS["const"].MATURE,b.direction=HS["const"].UPSTREAM,a.salmon.unshift(b)}})},HS.Program.prototype.preOrder=function(a){for(var b=this,c=0;c<b.tree.nodes.length;c++)a(b.tree.nodes[c])},HS.Program.prototype.postOrder=function(a){for(var b=this,c=b.tree.nodes.length-1;c>=0;c--)a(b.tree.nodes[c])},HS.Program.prototype.dumpFish=function(){var a=this;a.preOrder(function(b){for(var c=0;c<b.salmon.length;c++){var d=b.salmon[c],e="?",f="?";d.age==HS["const"].YOUNG&&(e="young"),d.age==HS["const"].MATURE&&(e="mature"),d.direction==HS["const"].UPSTREAM&&(f="upstream"),d.direction==HS["const"].DOWNSTREAM&&(f="downstream"),a.debug("node "+b.lname+': salmon "'+d.name+'", '+e+", "+f)}})},HS.Program.prototype.miscTick=function(){var a=this;a.debug("starting misc tick #"+a.tickNum),a.endThisTick&&a.debug("program exits!")},HS.Program.prototype.inputTick=function(){var a=this;a.debug("starting input tick #"+a.tickNum),a.endThisTick},HS.Program.prototype.tickSnow=function(){var a=this;a.tick(),a.preOrder(function(b){"marshy"==b.name?a.debug(b.name+" -> "+(b.is_snowy?"YES":"-")+(b.prev_snow?" / (YES)":" / (-)")):a.debug(b.name+" -> "+(b.is_snowy?"YES":"-"))})},HS.Program.prototype.tickWater=function(){var a=this;a.tick(),a.preOrder(function(b){a.debug(b.name+" -> "+(b.is_watered?"YES":"-"))})},HS.Nodes={},HS.Nodes.brige={blocksWater:function(){return this.is_destroyed}},HS.Nodes.downstream_sense={blocksPower:function(){return this.hasMatureDownstreamSalmon()}},HS.Nodes.evaporates={blocksWater:function(){return this.is_powered}},HS.Nodes.force_field={blocksWater:function(){return this.is_powered}},HS.Nodes.hydro_power={generatesPower:function(){return this.is_watered}},HS.Nodes.insulated={blocksPower:function(){return!0}},HS.Nodes.powers={generatesPower:function(){return!0}},HS.Nodes.range_sense={blocksPower:function(){return this.hasMatureSalmon()||this.hasMatureSalmonUpstream()}},HS.Nodes.range_switch={blocksPower:function(){return!this.hasMatureSalmon()&&!this.hasMatureSalmonUpstream()}},HS.Nodes.sense={blocksPower:function(){return this.hasMatureSalmon()}},HS.Nodes["switch"]={blocksPower:function(){return!this.hasMatureSalmon()}},HS.Nodes.upstream_sense={blocksPower:function(){return this.hasMatureUpstreamSalmon()}},HS.Nodes.young_range_sense={blocksPower:function(){return this.hasYoungSalmon()||this.hasYoungSalmonUpstream()}},HS.Nodes.young_range_switch={blocksPower:function(){return!this.hasYoungSalmon()&&!this.hasYoungSalmonUpstream()}},HS.Nodes.young_sense={blocksPower:function(){return this.hasYoungSalmon()}},HS.Nodes.young_switch={blocksPower:function(){return!this.hasYoungSalmon()}},HS.NodeDefs={};for(var i in HS.Nodes){HS.NodeDefs[i]=function(){HS.Node.apply(this,arguments)},HS.NodeDefs[i].prototype=Object.create(HS.Node.prototype);for(var j in HS.Nodes[i])HS.NodeDefs[i].prototype[j]=HS.Nodes[i][j]}